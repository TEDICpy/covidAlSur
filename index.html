<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">


      <script src="https://d3js.org/d3.v5.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/stickyfill/2.1.0/stickyfill.js"></script>
      <script src="https://unpkg.com/enter-view"></script>
      <link rel="stylesheet" href="scrolly.css">
  
</head>

<body>
      <script>
      var es_ES = {
        "decimal": ",",
        "thousands": ".",
        "grouping": [3],
        "currency": ["$", ""],
        "dateTime": "%a %b %e %X %Y",
        "date": "%d/%m/%Y",
        "time": "%H:%M:%S",
        "periods": ["AM", "PM"],
        "days": ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"],
        "shortDays": ["Dom", "Lun", "Mar", "Mi", "Jue", "Vie", "Sab"],
        "months": ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"],
        "shortMonths": ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"]
    };

    d3.timeFormatDefaultLocale(es_ES);
    d3.formatDefaultLocale(es_ES);

    var anchoDiv = document.getElementsByTagName("body")[0].clientWidth;
    var isMobile = anchoDiv < 768 ? 1 : 0; 

      </script>
    
  
  
      


<style>
body{
    font-family: sans-serif;
}
section {
    max-width: 1000px;
    margin:auto;
}

figure.contenedorGrafico {
    padding: 10px;
}

svg .paisLabel, svg .paisSubLabel{
    text-anchor: middle;
    font-family: sans-serif;
}

svg .paisSubLabel{
    opacity: 0.7;
}

figure p{
    max-width: 700px;
    margin: auto;
    text-align: left;
}

svg circle{
    stroke-width: 0px;
}

svg .axis rect{
    stroke-width: 0px;
}

svg .axis text{
    font-size: 13px;
}

svg .bajo{
    stroke: #ff5d12;
    fill:#ff5d1260
}

svg .medio{
    stroke: #6b9b2a;
    fill:#6b9b2a60
}

svg .alto{
    stroke: #069799;
    fill:#06979960
}



</style>

<section id='NOscrolly1'>
    <div class='NOscrolly'>
        <!-- aca va el grafico que va a quedar fijo -->
        <figure id="grafico1" class='sticky contenedorGrafico' >
            <h2>Acceso a internet y población</h2>
            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed eiusmod tempor incidunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquid ex ea commodi consequat. Quis aute iure reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint obcaecat cupiditat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>

            <div class="grafico"></div>

        </figure>

	</div>
</section>

<section id='NOscrolly1'>
    <div class='NOscrolly'>
        <!-- aca va el grafico que va a quedar fijo -->
        <figure id="grafico2" class='sticky contenedorGrafico' >
            <h2>Downloads y acceso a internet</h2>
            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed eiusmod tempor incidunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquid ex ea commodi consequat. Quis aute iure reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint obcaecat cupiditat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
            <div class="grafico"></div>
        </figure>

	</div>
</section>



<section id='scrolly1'>
    <div class='scrolly'>
        <!-- aca va el grafico que va a quedar fijo -->
        <figure id="grafico3" class='sticky contenedorGrafico' >
            <h2>Seguridad</h2>
            <div class="grafico"></div>
        </figure>

        <!-- acá van los textos de cada paso -->
        <article>
            <div class='step' data-index='0'>
			    <p>Estas son las apps mas xxx                </p>
            </div>
           
            <div class='step' data-index='1'>
			    <p>Estas son las apps mas xxx                </p>
            </div>


            <div class='step' data-index='2'>
			    <p>Estas son las apps mas xxx                </p>
            </div>

        </article>
		
	</div>
</section>




<section id='scrolly2'>
    <div class='scrolly'>
        <!-- aca va el grafico que va a quedar fijo -->
        <figure id="grafico4" class='sticky contenedorGrafico' >
            <h2>Recolección de datos</h2>
            <div class="grafico"></div>
        </figure>

        <!-- acá van los textos de cada paso -->
        <article>
            <div class='step' data-index='0'>
			    <p>Estas son las apps mas xxx                </p>
            </div>
           
            <div class='step' data-index='1'>
			    <p>Estas son las apps mas xxx                </p>
            </div>


            <div class='step' data-index='2'>
			    <p>Estas son las apps mas xxx                </p>
            </div>

        </article>
		
	</div>
</section>




<section id='scrolly3'>
    <div class='scrolly'>
        <!-- aca va el grafico que va a quedar fijo -->
        <figure id="grafico4" class='sticky contenedorGrafico' >
            <h2>La importancia del consentimiento en los datos recogidos por las apps</h2>
            <div class="grafico"></div>
        </figure>

        <!-- acá van los textos de cada paso -->
        <article>
            <div class='step' data-index='0'>
			    <p>Estas son las apps mas xxx                </p>
            </div>
           
            <div class='step' data-index='1'>
			    <p>Estas son las apps mas xxx                </p>
            </div>


            <div class='step' data-index='2'>
			    <p>Estas son las apps mas xxx                </p>
            </div>

        </article>
		
	</div>
</section>



 <!-- Scripts -->
 <script>
	
	//********************* CARGA DATOS ************

Promise.all([
    d3.csv("paises.csv"),
    d3.csv("apps_downloads.csv")

]).then(function(files) {
   
    
       


    // **** CODIGO DEL SCROLLY *******


    var container1 = d3.select('#scrolly1'); //busco el container total
	var container2 = d3.select('#scrolly2'); //busco el container total
    var container3 = d3.select('#scrolly3'); //busco el container total


    var stepSel1 = container1.selectAll('.step'); // selecciono los "steps"
	var stepSel2 = container2.selectAll('.step'); // selecciono los "steps"
    var stepSel3 = container3.selectAll('.step'); // selecciono los "steps"


    function updateChart(index, what,containerNumber,entra) {  // funcion que llama cada vez que cruza un umbral
        var sel = d3.select('#scrolly'+containerNumber).select(`[data-index='${index}']`);
        what.classed('is-active', (d, i) => i === index);
        scrollyTelling(containerNumber,index,entra); // <<<<< AQUI LLAMA AL GRAFICO VERDADERO
    }

    function init(what,containerNumber) { // configuracion inicial
        Stickyfill.add(d3.select('.sticky').node()); // fallback para browsers sin sticky

        enterView({
            selector: what.nodes(),
            offset: 0.4,
            enter: el => {
                var index = +d3.select(el).attr('data-index');
                updateChart(index,what,containerNumber,1);
            },
            exit: el => {
                let index = +d3.select(el).attr('data-index');
                index = Math.max(0, index - 1);
                updateChart(index,what,containerNumber,0);
            }
        });
    }
  
  

    // **** END SCROLLY *******


       
        

var altoMaximo = 1.5; // cuantas veces el ancho permitimos que sea el alto maximo

d3.selectAll(".contenedorGrafico")
        .selectAll(".grafico")
        .each(function(d,i){
            console.log(i);
                d3.select(this).append("svg").datum(i+1)});

var svg = d3.selectAll("svg")
    ,
    margin = isMobile ? {top: 15, right: 15, bottom: 15, left: 15} : {top: 15, right: 15, bottom: 15, left: 15},
    widthReal =  +d3.select('#grafico1').style('width').slice(0, -2),
    heightReal = +d3.select('#grafico1').style('height').slice(0, -2);




    svg.each(function(d){ 
        height = heightReal - margin.top - margin.bottom;
        width = widthReal - margin.left - margin.right;
            d3.select(this).attr("viewBox", [0, 0, widthReal, d3.select(this)._groups[0][0].parentElement.clientHeight])
        .attr("height", d3.select(this)._groups[0][0].parentElement.clientHeight)
        .attr("width", d3.select(this)._groups[0][0].parentElement.clientWidth);
    })

    

///******** MANEJO DE DATOS ********

 var dataPaises = files[0],
    dataPenetracion = files[1];


 dataPaises.forEach(element => {
			element.Acceso = element.Acceso.replace(",",".");
		});
    
//***************ACA SE ARMAN LOS GRAFICOS

svg
        .append("g")
        
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
	;

    svg.each(function(d,i){
        console.log(d);
		d3.select(this).select("g").attr("id","gInterno"+d.id)
        ;
	})



beeSwarmAcceso(dataPaises, "#gInterno0")
beeSwarmPenetracion(dataPenetracion, "#gInterno1")


//alluvialSeguridad(dataPaises, "#gInterno0")





function beeSwarmAcceso(datos, cualGrafico){ // beeswarm

        var main = d3.select(cualGrafico);
                height = main._groups[0][0].parentElement.height.baseVal.value-margin.top-margin.bottom;
                width = main._groups[0][0].parentElement.width.baseVal.value-margin.left-margin.right;

                var clasesAcceso = d3.scaleQuantize()
                .domain(d3.extent(datos, d=> d.Acceso))
                .range(["bajo", "medio", "alto"])
                ;


        var max_pop = d3.max(datos, d => d.Poblacion)
        
        
        var xScale = d3.scaleLinear().domain(d3.extent(datos, d=> d.Acceso));

            isMobile?xScale.range([height*0.1, height*0.9]):xScale.range([width*0.1, width*0.9]);

        var rScale = d3.scaleSqrt().domain([0, max_pop]).range([0, isMobile?width/30:height/30])
        
        
        var force = d3.forceSimulation(datos).force('forceX', d3.forceX(d => xScale(d.Acceso)).strength(2))
                .force('forceY', d3.forceY(height/2).strength(0.1));

        if(isMobile){
            force
                .force('forceY', d3.forceY(d => xScale(d.Acceso)).strength(2))
                .force('forceX', d3.forceX(width/1.8).strength(0.1))
        }
                
                force.force('collide', d3.forceCollide(d => rScale(d.Poblacion) + 3))
                .stop();
            
        var NUM_ITERATIONS = 120;
        
        for (let i = 0; i < NUM_ITERATIONS; ++i) {
            force.tick();
        };
        
        force.stop();
        
        var circlesGroup = main.selectAll("g")
            .data(datos)
            .join("g")
                .attr("transform", d=>"translate("+d.x+","+d.y+")");

            circlesGroup.append("circle")
            .attr("r", d => rScale(d.Poblacion))
            .attr("class", d=>clasesAcceso(d.Acceso));
            
        circlesGroup.append("text")
            .attr("class","paisLabel")
            .text(d=>d.Pais)
            .attr("dy",isMobile?5:2)
            .attr("font-size",16)
            .style("fill", "black");

       if(!isMobile){ circlesGroup.append("text")
            .attr("class","paisSubLabel")
            .text(d=>d3.format(".0%")(d.Acceso/100))
            .attr("dy",12)
            .attr("font-size",11)
            .style("fill", "black");

    }
            
        var axis = main.append("g").attr("class","axis")
            .style("transform", isMobile?`translateX(${width*0.1}px`:`translateY(${height*0.95}px`);

            var rangosAxis = [clasesAcceso.domain()[0],
                                clasesAcceso.thresholds()[0],
                                clasesAcceso.thresholds()[1],
                                clasesAcceso.domain()[1]];

            axis.selectAll("rect")
                .data(clasesAcceso.range())
                .join("rect")
                     .attr(isMobile?"y":"x", (d,i)=>xScale(rangosAxis[i]))
                    .attr(isMobile?"height":"width", (d,i)=> xScale(rangosAxis[i+1])-xScale(rangosAxis[i]))
                    .attr("class",d=>d)
                    .attr(isMobile?"width":"height",isMobile?3:18);


            axis.selectAll("text")
                .data(clasesAcceso.range())
                .join("text")
                    .attr(isMobile?"y":"x", (d,i)=>(xScale(rangosAxis[i])+xScale(rangosAxis[i+1]))/2)
                    .attr("dy",isMobile?0:14)
                    .attr("text-anchor",isMobile?"end":"middle")
                    .text(d=>d.toUpperCase());

        
} // fin beeswarm






function beeSwarmPenetracion(datos, cualGrafico){ // beeswarm

var main = d3.select(cualGrafico);
        height = main._groups[0][0].parentElement.height.baseVal.value-margin.top-margin.bottom;
        width = main._groups[0][0].parentElement.width.baseVal.value-margin.left-margin.right;

        var clasesAcceso = d3.scaleQuantize()
        .domain(d3.extent(datos, d=> d.Penetracion))
        .range(["bajo", "medio", "alto"])
        ;


var max_pop = d3.max(datos, d => d.Poblacion)


var xScale = d3.scaleLinear().domain(d3.extent(datos, d=> d.Penetracion));

    isMobile?xScale.range([height*0.1, height*0.9]):xScale.range([width*0.1, width*0.9]);

var rScale = d3.scaleSqrt().domain([0, max_pop]).range([0, isMobile?width/30:height/30])


var force = d3.forceSimulation(datos).force('forceX', d3.forceX(d => xScale(d.Penetracion)).strength(2))
        .force('forceY', d3.forceY(height/2).strength(0.1));

if(isMobile){
    force
        .force('forceY', d3.forceY(d => xScale(d.Penetracion)).strength(2))
        .force('forceX', d3.forceX(width/1.8).strength(0.1))
}
        
        force.force('collide', d3.forceCollide(d => rScale(d.Poblacion) + 3))
        .stop();
    
var NUM_ITERATIONS = 120;

for (let i = 0; i < NUM_ITERATIONS; ++i) {
    force.tick();
};

force.stop();

var circlesGroup = main.selectAll("g")
    .data(datos)
    .join("g")
        .attr("transform", d=>"translate("+d.x+","+d.y+")");

    circlesGroup.append("circle")
    .attr("r", d => rScale(d.Poblacion))
    .attr("class", d=>clasesAcceso(d.Penetracion));
    
circlesGroup.append("text")
    .attr("class","paisLabel")
    .text(d=>d.Pais)
    .attr("dy",isMobile?5:2)
    .attr("font-size",16)
    .style("fill", "black");

if(!isMobile){ circlesGroup.append("text")
    .attr("class","paisSubLabel")
    .text(d=>d3.format(".0%")(d.Penetracion/100))
    .attr("dy",12)
    .attr("font-size",11)
    .style("fill", "black");

}
    
var axis = main.append("g").attr("class","axis")
    .style("transform", isMobile?`translateX(${width*0.1}px`:`translateY(${height*0.95}px`);

    var rangosAxis = [clasesAcceso.domain()[0],
                        clasesAcceso.thresholds()[0],
                        clasesAcceso.thresholds()[1],
                        clasesAcceso.domain()[1]];

    axis.selectAll("rect")
        .data(clasesAcceso.range())
        .join("rect")
             .attr(isMobile?"y":"x", (d,i)=>xScale(rangosAxis[i]))
            .attr(isMobile?"height":"width", (d,i)=> xScale(rangosAxis[i+1])-xScale(rangosAxis[i]))
            .attr("class",d=>d)
            .attr(isMobile?"width":"height",isMobile?3:18);


    axis.selectAll("text")
        .data(clasesAcceso.range())
        .join("text")
            .attr(isMobile?"y":"x", (d,i)=>(xScale(rangosAxis[i])+xScale(rangosAxis[i+1]))/2)
            .attr("dy",isMobile?0:14)
            .attr("text-anchor",isMobile?"end":"middle")
            .text(d=>d.toUpperCase());


} // fin beeswarm





        init(stepSel1,1)
	    init(stepSel2,2)
        init(stepSel3,3)


//***************ACA SE MODIFICAN EN CADA STEP
        
        
 

function scrollyTelling(containerNumber,step,entra){
	if(containerNumber == 1){  //GRAFICO PRIMER SCROLLY
		switch (step) {
			case 0: // testeos y positivos 
              
			break;
      
	    }

	}else if(containerNumber == 2){

        switch (step) {
			case 0: // testeos y positivos 
              
			break;
      
	    }
              
    }else {

        switch (step) {
			case 0: // testeos y positivos 
              
			break;
      
	    }

    }
        

}



//********** funciones
 



});

</script>

    

  
  
 

  

</body>
</html>